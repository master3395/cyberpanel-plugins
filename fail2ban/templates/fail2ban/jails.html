{% extends "baseTemplate/index.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extraCSS %}
<style>
/* Reuse styles from dashboard */
:root {
    --primary-color: #667eea;
    --primary-dark: #5a67d8;
    --secondary-color: #edf2f7;
    --success-color: #48bb78;
    --warning-color: #ed8936;
    --danger-color: #f56565;
    --info-color: #4299e1;
    --dark-color: #2d3748;
    --light-color: #f7fafc;
    --border-color: #e2e8f0;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --border-radius: 8px;
    --transition: all 0.3s ease;
}

.jails-container {
    background: var(--light-color);
    min-height: 100vh;
    padding: 20px;
}

.page-header {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
    padding: 30px;
    border-radius: var(--border-radius);
    margin-bottom: 30px;
    box-shadow: var(--shadow);
}

.jails-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.jail-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: var(--transition);
}

.jail-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.jail-header {
    background: var(--secondary-color);
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.jail-name {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--dark-color);
}

.jail-status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.jail-status.enabled {
    background: #c6f6d5;
    color: #22543d;
}

.jail-status.disabled {
    background: #fed7d7;
    color: #742a2a;
}

.jail-body {
    padding: 20px;
}

.jail-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark-color);
    margin: 0;
}

.stat-label {
    font-size: 0.8rem;
    color: #718096;
    margin: 2px 0 0 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.jail-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: none;
    border-radius: var(--border-radius);
    font-size: 0.8rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
    flex: 1;
    justify-content: center;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-warning {
    background: var(--warning-color);
    color: white;
}

.btn:hover {
    transform: translateY(-1px);
    opacity: 0.9;
}

.banned-ips-list {
    max-height: 150px;
    overflow-y: auto;
    background: #f8f9fa;
    border-radius: var(--border-radius);
    padding: 10px;
    margin-top: 10px;
}

.banned-ip-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #e2e8f0;
}

.banned-ip-item:last-child {
    border-bottom: none;
}

.ip-address {
    font-family: monospace;
    font-size: 0.9rem;
    color: var(--dark-color);
}

.unban-btn {
    background: var(--success-color);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.7rem;
    cursor: pointer;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .jails-container {
        padding: 10px;
    }
    
    .jails-grid {
        grid-template-columns: 1fr;
    }
    
    .jail-stats {
        grid-template-columns: 1fr;
    }
    
    .jail-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="jails-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1>üîí Jails Management</h1>
        <p>Monitor and control fail2ban jails for different services</p>
    </div>

    <!-- Jails Grid -->
    <div class="jails-grid" id="jails-grid">
        <div class="loading"></div> Loading jails...
    </div>
</div>

<script>
// Load jails data
async function loadJails() {
    try {
        const response = await fetch('/plugins/fail2ban/api/jails/');
        const data = await response.json();
        
        if (data.success) {
            displayJails(data.data);
        } else {
            document.getElementById('jails-grid').innerHTML = 
                '<div class="alert alert-danger">Error loading jails: ' + data.error + '</div>';
        }
    } catch (error) {
        console.error('Error loading jails:', error);
        document.getElementById('jails-grid').innerHTML = 
            '<div class="alert alert-danger">Error loading jails</div>';
    }
}

// Display jails
function displayJails(jails) {
    const grid = document.getElementById('jails-grid');
    
    if (jails.length === 0) {
        grid.innerHTML = '<div class="alert alert-info">No jails found</div>';
        return;
    }
    
    let html = '';
    
    jails.forEach(jail => {
        const bannedIPs = jail.banned_ip_list || [];
        const bannedIPsHTML = bannedIPs.length > 0 
            ? bannedIPs.map(ip => `
                <div class="banned-ip-item">
                    <span class="ip-address">${ip}</span>
                    <button class="unban-btn" onclick="unbanIP('${ip}', '${jail.name}')">
                        Unban
                    </button>
                </div>
            `).join('')
            : '<p style="color: #718096; font-style: italic;">No banned IPs</p>';
        
        html += `
            <div class="jail-card">
                <div class="jail-header">
                    <h3 class="jail-name">${jail.name}</h3>
                    <div class="jail-status ${jail.enabled ? 'enabled' : 'disabled'}">
                        ${jail.enabled ? '‚úì Enabled' : '‚úó Disabled'}
                    </div>
                </div>
                <div class="jail-body">
                    <div class="jail-stats">
                        <div class="stat-item">
                            <h4 class="stat-number">${jail.failed_attempts || 0}</h4>
                            <p class="stat-label">Failed Attempts</p>
                        </div>
                        <div class="stat-item">
                            <h4 class="stat-number">${jail.banned_ips || 0}</h4>
                            <p class="stat-label">Banned IPs</p>
                        </div>
                    </div>
                    
                    <div class="banned-ips-list">
                        <h5 style="margin: 0 0 10px 0; color: var(--dark-color);">Banned IPs:</h5>
                        ${bannedIPsHTML}
                    </div>
                    
                    <div class="jail-actions">
                        <button class="btn btn-primary" onclick="viewJailDetails('${jail.name}')">
                            üìä Details
                        </button>
                        <button class="btn btn-warning" onclick="toggleJail('${jail.name}', ${jail.enabled})">
                            ${jail.enabled ? '‚è∏Ô∏è Disable' : '‚ñ∂Ô∏è Enable'}
                        </button>
                        <button class="btn btn-danger" onclick="unbanAllIPs('${jail.name}')">
                            üö´ Unban All
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    grid.innerHTML = html;
}

// Unban IP
async function unbanIP(ip, jail) {
    try {
        const response = await fetch('/plugins/fail2ban/api/unban-ip/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                ip: ip,
                jail: jail
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(`IP ${ip} unbanned from ${jail}`, 'success');
            loadJails(); // Reload to update the display
        } else {
            showAlert(`Failed to unban IP: ${data.error}`, 'danger');
        }
    } catch (error) {
        console.error('Error unbanning IP:', error);
        showAlert('Error unbanning IP', 'danger');
    }
}

// Unban all IPs from a jail
async function unbanAllIPs(jail) {
    if (!confirm(`Are you sure you want to unban all IPs from ${jail}?`)) {
        return;
    }
    
    try {
        // Get all banned IPs for this jail first
        const response = await fetch('/plugins/fail2ban/api/jails/');
        const data = await response.json();
        
        if (data.success) {
            const jailData = data.data.find(j => j.name === jail);
            if (jailData && jailData.banned_ip_list) {
                // Unban each IP
                for (const ip of jailData.banned_ip_list) {
                    await unbanIP(ip, jail);
                }
                showAlert(`All IPs unbanned from ${jail}`, 'success');
            }
        }
    } catch (error) {
        console.error('Error unbanning all IPs:', error);
        showAlert('Error unbanning all IPs', 'danger');
    }
}

// Toggle jail (placeholder)
function toggleJail(jail, enabled) {
    showAlert(`Toggle jail ${jail} - Coming soon!`, 'info');
}

// View jail details (placeholder)
function viewJailDetails(jail) {
    showAlert(`View details for ${jail} - Coming soon!`, 'info');
}

// Show alert
function showAlert(message, type) {
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        max-width: 400px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    `;
    
    if (type === 'success') {
        alert.style.background = '#48bb78';
    } else if (type === 'danger') {
        alert.style.background = '#f56565';
    } else if (type === 'warning') {
        alert.style.background = '#ed8936';
    } else {
        alert.style.background = '#4299e1';
    }
    
    alert.textContent = message;
    document.body.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Load jails on page load
document.addEventListener('DOMContentLoaded', function() {
    loadJails();
});
</script>
{% endblock %}
